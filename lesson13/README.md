# Lesson 13 Сбор и анализ логов.

## Задание:
<pre>
Настраиваем центральный сервер для сбора логов
в вагранте поднимаем 2 машины web и log
на web поднимаем nginx
на log настраиваем центральный лог сервер на любой системе на выбор
- [x] journald
- [_] rsyslog
- [x] elk 
настраиваем аудит следящий за изменением конфигов нжинкса 

все критичные логи с web должны собираться и локально и удаленно
все логи с nginx должны уходить на удаленный сервер (локально только критичные)
логи аудита должны также уходить на удаленную систему


* развернуть еще машину elk
и таким образом настроить 2 центральных лог системы elk И какую либо еще
в elk должны уходить только логи нжинкса
во вторую систему все остальное
Критерии оценки: 4 - если присылают только логи скриншоты без вагранта
5 - за полную настройку
6 - если выполнено задание со звездочкой
</pre>


## Решение:
Было принято решение развернуть стек ELK и journalD 

Разворачиваю 4 виртуальные машины:
 - Ansible машина - для исключения проблем с настройками на разных ОС. Вся установка производится с помощью ролей с данной машины 
 <details> 
[Roles Ansible] ( ansible / roles ) Составлены сиходя из решения - отдельная роль на каждую отдельное "фичу" которую можно переиспользовать независимо от на не зависимых машинах. Например [Nginx](ansible/roles/roles/nginx), [Filebeat](ansible/roles/roles/filebeat) и прочее... Для установки достаточно сформировать файл YML для установки роли, все необходимые зависимости роль доустановит сама.
 </details> 
 - NGINX. Веб сервер NGINX.
 <details> 
- Разворачиваю веб сервер [NGINX](ansible/roles/roles/nginx) который размещает на 80 порту [веб страничку](http://192.168.11.141), для удаленного сбора логов в стеке ELK
- Установливаем [filebat](ansible/roles/roles/filebeat), который отправляет выбранные логи (access и error) в Logstash, который в свою очередь отправляется в ElasicSearch. 
- Сервис [auditd](ansible/roles/roles/auditd_client/tasks/main.yml) отправляет все сообщения auditd на сервер ServerLog (log2).
- Сервис [systemd-journal-upload](ansible/roles/roles/sd_jd_client) отправляет логи kournald на сервер логов
 </details> 
 - Kinaba. Стек ELK.
 <details> 
 На машине в Docker разворачивается стек ELK [elasticsearch, kibana и logstash](ansible/roles/roles/kibana/tasks/main.yml). Веб "морда" [слушает](http://192.168.11.140:5601) на стандартном порту 5601.
 При первом входе необходимо указать "Index patterns" - в нашем случае достаточно указать "*" и @timestamp в качестве временной метки.
 </details> 
 - ServerLog. - сервер для удаленного сбора логов через JournalD и Audit
  <details> 
 На сервере настроено:
  Сервис [auditd](ansible/roles/roles/auditd_server/tasks/main.yml) слушает на 60 порту то что приходит от Веб сервера.
  Сервис [systemd-journal-remote](ansible/roles/roles/sd_jd_server/tasks/main.yml) собирает лого от удаленных систем.
 </details> 


**Andrey Agafonov 2019 aagafonov@inbox.ru**
