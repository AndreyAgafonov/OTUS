    - hosts: elastic_eu:elastic_us:elastic_asia:elastic_office:elastic_remote 
      tasks:
        - name: check if Elasticsearch is installed
          package: name=elasticsearch state=present
          check_mode: true
          register: package_check

        - name: Install dependencies
          apt: pkg=locales-all,openjdk-8-jdk,apt-transport-https state=installed update_cache=true
          when: package_check.changed

        - name: Install Elasticsearch
          shell: cd /tmp; wget https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/deb/elasticsearch/2.3.3/elasticsearch-2.3.3.deb; dpkg -i /tmp/elasticsearch-2.3.3.deb
          when: package_check.changed 

        - name: Tweak system vm.max_map_count
          sysctl: name=vm.max_map_count value=262144 state=present reload=yes
          when: package_check.changed

        - name: Tweak system vm.swappiness
          sysctl: name=vm.swappiness value=1 state=present reload=yes
          when: package_check.changed

        - name: Tweak system limits
          pam_limits: domain='*' limit_type=soft limit_item=nofile value=550000
          when: package_check.changed

        - name: Tweak system limits 2
          pam_limits: domain='*' limit_type=hard limit_item=nofile value=550000
          when: package_check.changed

        - name: Push Elasticsearch config file 
          template: src=templates/elasticsearch.yml.j2 dest=/etc/elasticsearch/elasticsearch.yml mode=0640 owner=elasticsearch group=elasticsearch
          when: package_check.changed
          notify:
            - restart elasticsearch

        - name: Set {{ elastic_ram }} RAM for Elasticsearch JVM
          template: src=templates/elasticsearch.j2 dest=/etc/default/elasticsearch mode=0644 owner=root group=root
          when: package_check.changed
          notify:
            - restart elasticsearch

        - name: Autostart service Elasticsearch
          systemd: name=elasticsearch enabled=yes
          when: package_check.changed

      handlers:
        - name: restart elasticsearch
          service: name=elasticsearch state=restarted
